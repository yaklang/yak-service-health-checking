// =============================================================================
// YAK Services Health Checking - æœåŠ¡å¥åº·æ£€æŸ¥ç›‘æ§ç³»ç»Ÿ
// åŠŸèƒ½: å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼Œå®šæœŸæ£€æŸ¥å¤šä¸ªæœåŠ¡çš„å¥åº·çŠ¶æ€å¹¶å±•ç¤º
// ç”¨é€”: æœåŠ¡ç›‘æ§ã€å¥åº·æ£€æŸ¥ã€çŠ¶æ€å±•ç¤ºã€å®æ—¶æ›´æ–°
//
// æ ¸å¿ƒæŠ€æœ¯æ ˆ:
// - httpserver.Serve: å¯åŠ¨ HTTP æœåŠ¡å™¨
// - poc.HTTP: å‘èµ· HTTP/HTTPS è¯·æ±‚æ£€æŸ¥æœåŠ¡çŠ¶æ€
// - json.dumps/json.loads: JSON æ•°æ®å¤„ç†
// - time.Now: æ—¶é—´æˆ³è®°å½•
// - sync.Mutex: å¹¶å‘å®‰å…¨çš„æ•°æ®è®¿é—®
//
// ä½¿ç”¨ç¤ºä¾‹:
// yak apps/health-checking/health-checking.yak --port 8080 --interval 60
//
// åº”ç”¨åœºæ™¯: æœåŠ¡ç›‘æ§ã€å¥åº·æ£€æŸ¥ã€çŠ¶æ€å¯è§†åŒ–ã€å®æ—¶ç›‘æ§
// å…³é”®è¯: health-check monitoring httpserver poc æœåŠ¡ç›‘æ§ å¥åº·æ£€æŸ¥
// æœç´¢æ ‡ç­¾: #health-check #monitoring #httpserver #service-status
// =============================================================================

// =============================================================================
// CLI å‚æ•°é…ç½®æ¨¡å— - å‘½ä»¤è¡Œæ¥å£å®šä¹‰
// åŠŸèƒ½: å®šä¹‰è„šæœ¬çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œæ”¯æŒè‡ªå®šä¹‰ç«¯å£å’Œæ£€æŸ¥é—´éš”
// æŠ€æœ¯: cli.String/Int å‚æ•°è§£æï¼Œcli.setDefault é»˜è®¤å€¼
//
// å‚æ•°è¯´æ˜:
// - port: ç›‘æ§æœåŠ¡ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ 8080
// - interval: å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 60
// - timeout: HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 10
//
// ä½¿ç”¨ç¤ºä¾‹: 
// yak health-checking.yak --port 8080 --interval 60 --timeout 10
// =============================================================================

// æœåŠ¡ç«¯å£é…ç½®
port = cli.Int(
    "port", 
    cli.setDefault(8080), 
    cli.setHelp("ç›‘æ§æœåŠ¡ç›‘å¬ç«¯å£")
)

htmlDir = cli.String("html-dir", cli.setDefault("/root/yak-services-health-checking/"))

// å¥åº·æ£€æŸ¥é—´éš”
interval = cli.Int(
    "interval",
    cli.setDefault(60),
    cli.setHelp("å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰")
)

// HTTP è¯·æ±‚è¶…æ—¶
timeout = cli.Int(
    "timeout",
    cli.setDefault(10),
    cli.setHelp("HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰")
)

// Bot æŠ¥è­¦é…ç½®
botWebhook = cli.String(
    "bot-webhook",
    cli.setDefault(""),
    cli.setHelp("Bot webhook URLï¼Œç”¨äºå‘é€æŠ¥è­¦é€šçŸ¥")
)

// Mock æŠ¥è­¦æµ‹è¯•æ¨¡å¼
mockAlert = cli.Bool(
    "mock-alert",
    cli.setDefault(false),
    cli.setHelp("å¯ç”¨ Mock æŠ¥è­¦æµ‹è¯•æ¨¡å¼ï¼Œæ·»åŠ ä¸€ä¸ªå¿…å®šå¤±è´¥çš„å¥åº·æ£€æŸ¥ç”¨äºæµ‹è¯•æŠ¥è­¦åŠŸèƒ½")
)

// æŠ¥è­¦é—´éš”é…ç½®
alertInterval = cli.Int(
    "alert-interval",
    cli.setDefault(3600),
    cli.setHelp("æŠ¥è­¦é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼ŒåŒä¸€æœåŠ¡åœ¨æ­¤æ—¶é—´å†…ä¸ä¼šé‡å¤æŠ¥è­¦ï¼Œé»˜è®¤3600ç§’ï¼ˆ1å°æ—¶ï¼‰")
)

var botClient

// éªŒè¯å‚æ•°
cli.check()

// å¦‚æœæœªæŒ‡å®š webhookï¼Œå°è¯•ä»æœ¬åœ°æ–‡ä»¶è¯»å–
if botWebhook == "" {
    content, err = file.ReadFile("/tmp/lark.txt")
    if err == nil {
        botWebhook = str.TrimSpace(string(content))
        log.info("Loaded webhook from /tmp/lark.txt")
    } else {
        log.info("No webhook configured (neither --bot-webhook nor /tmp/lark.txt found)")
    }
} else {
    log.info("Using webhook from command line parameter")
}

log.info("Starting YAK Services Health Checking System...")
log.info("Configuration:")
log.info("  Port: %d", port)
log.info("  Check Interval: %d seconds", interval)
log.info("  Request Timeout: %d seconds", timeout)
log.info("  Alert Interval: %d seconds (%d minutes)", alertInterval, alertInterval/60)
if botWebhook != "" {
    log.info("  Bot Webhook: %s", botWebhook)
    // åˆå§‹åŒ– bot å®¢æˆ·ç«¯
    try {
        botClient = bot.New(bot.webhook(botWebhook))
        if botClient == nil {
            log.error("Failed to create bot client - returned nil")
        } else if len(botClient.Configs()) == 0 {
            log.error("Failed to initialize bot client - no configs found")
            botClient = nil
        } else {
            log.info("Bot client initialized successfully with %d config(s)", len(botClient.Configs()))
        }
    } catch err {
        log.error("Exception while initializing bot client: %v", err)
        botClient = nil
    }
} else {
    log.info("  Bot Webhook: Not configured")
}

// =============================================================================
// æœåŠ¡é…ç½®æ¨¡å— - å®šä¹‰éœ€è¦ç›‘æ§çš„æœåŠ¡åˆ—è¡¨
// åŠŸèƒ½: é…ç½®éœ€è¦ç›‘æ§çš„æœåŠ¡ï¼ŒåŒ…æ‹¬æœåŠ¡IDã€åç§°å’Œå¥åº·æ£€æŸ¥URL
// æŠ€æœ¯: Map æ•°æ®ç»“æ„å­˜å‚¨æœåŠ¡é…ç½®
//
// æœåŠ¡é…ç½®æ ¼å¼:
// {
//   "service_id": "æœåŠ¡å”¯ä¸€æ ‡è¯†",
//   "service_name": "æœåŠ¡ä¸­æ–‡åç§°",
//   "service_name_en": "æœåŠ¡è‹±æ–‡åç§°",
//   "health_url": "å¥åº·æ£€æŸ¥URL",
//   "method": "HTTPæ–¹æ³•ï¼ˆé»˜è®¤GETï¼‰"
// }
// =============================================================================

serviceConfigs = [
    {
        "service_id": "yaklang_com",
        "service_name": "Yaklang å®˜ç½‘",
        "service_name_en": "Yaklang Official",
        "health_url": "https://yaklang.com",
        "expect_status": 200,
        "expect_keywords": ["Docusaurus", "Yak Program Language"]
    },
    {
        "service_id": "yaklang_io",
        "service_name": "Yaklang å›½é™…å®˜ç½‘",
        "service_name_en": "Yaklang International",
        "health_url": "https://yaklang.io",
        "expect_status": 200,
        "expect_keywords": ["Docusaurus", "Yak Program Language"]
    },
    {
        "service_id": "ssa_to",
        "service_name": "IRify SSA æŠ€æœ¯å®˜ç½‘",
        "service_name_en": "IRify SSA Official",
        "health_url": "https://ssa.to",
        "expect_status": 200,
        "expect_keywords": ["Docusaurus", "SSA-IR", "ç¼–è¯‘å™¨çº§"]
    },
    {
        "service_id": "aibalance",
        "service_name": "Yaklang AI è´Ÿè½½å‡è¡¡",
        "service_name_en": "Yaklang AI Balance",
        "health_url": "https://aibalance.yaklang.com",
        "expect_status": 200,
        "expect_keywords": ["AI Balance", "Orbitron"]
    },
    {
        "service_id": "codescan_ssa",
        "service_name": "SSA ä»£ç æ‰«æ",
        "service_name_en": "SSA Code Scan",
        "health_url": "https://codescan.ssa.to",
        "expect_status": 404,
        "expect_keywords": ["404", "not found"]
    },
    {
        "service_id": "embedding_service",
        "service_name": "YAK Embedding Service",
        "service_name_en": "YAK Embedding Service",
        "health_url": "https://embedding.yaklang.com",
        "expect_status": 200,
        "expect_keywords": ["Hello Yak!"],
        "retry_times": 3
    },
    {
        "service_id": "code_helper",
        "service_name": "Yaklang ä»£ç åŠ©æ‰‹",
        "service_name_en": "Yaklang Code Helper",
        "health_url": "https://code-helper.yaklang.com",
        "expect_status": 200,
        "expect_keywords": ["ç¼–ç¨‹åŠ©æ‰‹", "Yaklang"],
    },
]

// å¦‚æœå¯ç”¨äº† Mock æŠ¥è­¦æµ‹è¯•æ¨¡å¼ï¼Œæ·»åŠ ä¸€ä¸ªå¿…å®šå¤±è´¥çš„æœåŠ¡
if mockAlert {
    mockService = {
        "service_id": "mock_alert_test",
        "service_name": "Mock æŠ¥è­¦æµ‹è¯•æœåŠ¡",
        "service_name_en": "Mock Alert Test Service",
        "health_url": "http://mock-alert-test-non-existent-domain-12345.invalid",
        "expect_status": 200,
        "expect_keywords": ["success"]
    }
    serviceConfigs = append(serviceConfigs, mockService)
    log.info("Mock alert mode enabled, added test failure service")
}

log.info("Configured %d services for monitoring", len(serviceConfigs))

// =============================================================================
// å¥åº·çŠ¶æ€æ•°æ®å­˜å‚¨æ¨¡å— - çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†
// åŠŸèƒ½: å­˜å‚¨å’Œç®¡ç†æ‰€æœ‰æœåŠ¡çš„å¥åº·çŠ¶æ€æ•°æ®
// æŠ€æœ¯: sync.NewMutex åˆ›å»ºäº’æ–¥é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨
//
// æ•°æ®ç»“æ„:
// [
//   {
//     "service_id": "aibalance",
//     "service_name": "AIå‡è¡¡å™¨",
//     "service_name_en": "AI Balance",
//     "status_code": 200,
//     "response": "å“åº”å†…å®¹æ‘˜è¦",
//     "updated_at": "2024-01-01T12:00:00Z"
//   }
// ]
// =============================================================================

healthData = []
healthDataMutex = sync.NewMutex()

// æŠ¥è­¦çŠ¶æ€è·Ÿè¸ª - åŸºäºæ—¶é—´çš„æŠ¥è­¦é¢‘ç‡æ§åˆ¶
alertedServices = {}  // å·²æŠ¥è­¦çš„æœåŠ¡åŠå…¶æœ€åæŠ¥è­¦æ—¶é—´ {"service_id": timestamp}
alertedServicesMutex = sync.NewMutex()

log.info("Initialized health data storage with mutex lock")

// =============================================================================
// å¥åº·æ£€æŸ¥æ‰§è¡Œæ¨¡å— - æ£€æŸ¥å•ä¸ªæœåŠ¡çš„å¥åº·çŠ¶æ€
// åŠŸèƒ½: å‘æŒ‡å®šæœåŠ¡å‘é€ HTTP è¯·æ±‚ï¼Œè·å–å¥åº·çŠ¶æ€
// æŠ€æœ¯: poc.HTTP å‘èµ·è¯·æ±‚ï¼Œpoc.GetStatusCodeFromResponse è·å–çŠ¶æ€ç 
//
// å‚æ•°:
// - config: æœåŠ¡é…ç½®å¯¹è±¡
//
// è¿”å›:
// - æœåŠ¡å¥åº·çŠ¶æ€å¯¹è±¡
// =============================================================================

checkServiceHealthOneTime = func(config) {
    log.info("Checking health for service: %s", config["service_id"])
    
    serviceId = config["service_id"]
    serviceName = config["service_name"]
    serviceNameEn = config["service_name_en"]
    healthUrl = config["health_url"]
    expectStatus = config["expect_status"] || 200
    expectKeywords = config["expect_keywords"] || []
    
    // æ„å»ºå¥åº·çŠ¶æ€å¯¹è±¡
    healthStatus = {
        "service_id": serviceId,
        "service_name": serviceName,
        "service_name_en": serviceNameEn,
        "status_code": 0,
        "response": "",
        "is_healthy": false,
        "check_detail": "",
        "updated_at": time.Now().Format("2006-01-02T15:04:05Z07:00")
    }
    
    log.info("Sending GET request to %s", healthUrl)
    
    // å‘èµ·è¯·æ±‚
    try {
        packet = f`GET ${healthUrl} HTTP/1.1
Host: auto
User-Agent: YAK-Health-Checker/1.0

`
        
        rsp, req, err = poc.HTTP(packet, poc.timeout(timeout))
        
        if err != nil {
            log.error("HTTP request failed for %s: %v", serviceId, err)
            healthStatus["response"] = f"Request error: ${err}"
            healthStatus["check_detail"] = f"Network error: ${err}"
            return healthStatus
        }
        
        // è·å–çŠ¶æ€ç 
        statusCode = poc.GetStatusCodeFromResponse(rsp)
        healthStatus["status_code"] = statusCode
        
        // è·å–å®Œæ•´å“åº”ä½“ç”¨äºå…³é”®å­—æ£€æŸ¥
        _, body = poc.Split(rsp)
        bodyStr = string(body)
        fullBody = bodyStr
        
        // å­˜å‚¨ç®€çŸ­å“åº”
        if len(bodyStr) > 200 {
            bodyStr = bodyStr[:200] + "..."
        }
        healthStatus["response"] = bodyStr
        
        // éªŒè¯çŠ¶æ€ç 
        statusMatch = (statusCode == expectStatus)
        
        // éªŒè¯å…³é”®å­—
        keywordMatch = true
        matchedKeywords = []
        if len(expectKeywords) > 0 {
            for keyword in expectKeywords {
                if str.Contains(fullBody, keyword) {
                    matchedKeywords = append(matchedKeywords, keyword)
                }
            }
            keywordMatch = (len(matchedKeywords) > 0)
        }
        
        // åˆ¤æ–­æ•´ä½“å¥åº·çŠ¶æ€
        healthStatus["is_healthy"] = (statusMatch && keywordMatch)
        
        // æ„å»ºæ£€æŸ¥è¯¦æƒ…
        if healthStatus["is_healthy"] {
            healthStatus["check_detail"] = f"Status: ${statusCode} (expected ${expectStatus}), Keywords matched: ${len(matchedKeywords)}/${len(expectKeywords)}"
        } else {
            if !statusMatch {
                healthStatus["check_detail"] = f"Status mismatch: got ${statusCode}, expected ${expectStatus}"
            } else {
                healthStatus["check_detail"] = f"Keywords missing: matched ${len(matchedKeywords)}/${len(expectKeywords)}"
            }
        }
        
        log.info("Health check completed for %s: healthy=%v, status=%d", serviceId, healthStatus["is_healthy"], statusCode)
        
    } catch err {
        log.error("Exception during health check for %s: %v", serviceId, err)
        healthStatus["response"] = f"Exception: ${err}"
        healthStatus["check_detail"] = f"Exception: ${err}"
    }
    
    return healthStatus
}

// =============================================================================
// å¥åº·æ£€æŸ¥æ‰§è¡Œæ¨¡å— - æ£€æŸ¥å•ä¸ªæœåŠ¡çš„å¥åº·çŠ¶æ€ï¼ˆæ”¯æŒé‡è¯•ï¼‰
// åŠŸèƒ½: å‘æŒ‡å®šæœåŠ¡å‘é€ HTTP è¯·æ±‚ï¼Œè·å–å¥åº·çŠ¶æ€ï¼Œæ”¯æŒé‡è¯•æœºåˆ¶
// æŠ€æœ¯: è°ƒç”¨ checkServiceHealthOneTime å®ç°å•æ¬¡æ£€æŸ¥ï¼Œå¾ªç¯å®ç°é‡è¯•
//
// å‚æ•°:
// - config: æœåŠ¡é…ç½®å¯¹è±¡
//
// è¿”å›:
// - æœåŠ¡å¥åº·çŠ¶æ€å¯¹è±¡
// =============================================================================

checkServiceHealth = func(config) {
    log.info("Checking health for service: %s", config["service_id"])

    serviceId = config["service_id"]
    retryTimes = config["retry_times"] || 1

    // å¦‚æœä¸éœ€è¦é‡è¯•ï¼Œç›´æ¥è°ƒç”¨å•æ¬¡æ£€æŸ¥
    if retryTimes <= 1 {
        return checkServiceHealthOneTime(config)
    }

    log.info("Service %s configured with %d retry attempts", serviceId, retryTimes)

    // é‡è¯•å¾ªç¯
    for attempt = 1; attempt <= retryTimes; attempt++ {
        log.info("Attempt %d/%d for service %s", attempt, retryTimes, serviceId)

        // æ‰§è¡Œå•æ¬¡å¥åº·æ£€æŸ¥
        healthStatus = checkServiceHealthOneTime(config)

        // å¦‚æœæ£€æŸ¥æˆåŠŸï¼Œç›´æ¥è¿”å›
        if healthStatus["is_healthy"] {
            if attempt > 1 {
                log.info("Service %s succeeded on attempt %d/%d", serviceId, attempt, retryTimes)
                // æ›´æ–°æ£€æŸ¥è¯¦æƒ…ï¼Œæ˜¾ç¤ºé‡è¯•æˆåŠŸä¿¡æ¯
                healthStatus["check_detail"] = f"${healthStatus['check_detail']} (succeeded on attempt ${attempt}/${retryTimes})"
            }
            return healthStatus
        }

        // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œè¿”å›å¤±è´¥ç»“æœ
        if attempt == retryTimes {
            log.warn("Service %s failed all %d attempts", serviceId, retryTimes)
            // æ›´æ–°æ£€æŸ¥è¯¦æƒ…ï¼Œæ˜¾ç¤ºæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
            healthStatus["check_detail"] = f"${healthStatus['check_detail']} (all ${retryTimes} attempts failed)"
            return healthStatus
        }

        // ç­‰å¾… 2 ç§’åé‡è¯•
        log.info("Service %s attempt %d/%d failed, retrying in 2 seconds...", serviceId, attempt, retryTimes)
        sleep(2)
    }

    // ç†è®ºä¸Šä¸ä¼šåˆ°è¾¾è¿™é‡Œï¼Œä½†ä¸ºäº†å®‰å…¨èµ·è§
    return checkServiceHealthOneTime(config)
}

// =============================================================================
// æŠ¥è­¦åŠŸèƒ½æ¨¡å— - å‘é€å¥åº·çŠ¶æ€æŠ¥è­¦
// åŠŸèƒ½: å½“æœåŠ¡ä¸å¥åº·æ—¶å‘é€æŠ¥è­¦é€šçŸ¥ï¼Œé¿å…é‡å¤æŠ¥è­¦
// æŠ€æœ¯: ä½¿ç”¨äº’æ–¥é”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œbot å®¢æˆ·ç«¯å‘é€é€šçŸ¥
// æ³¨æ„: è¿™äº›å‡½æ•°å°†åœ¨ botClient åˆå§‹åŒ–åé‡æ–°å®šä¹‰
// =============================================================================

// å‘é€å¥åº·æŠ¥è­¦
sendHealthAlert = func(healthStatus) {
    log.info("sendHealthAlert called for service %s", healthStatus["service_id"])
    if botClient == nil {
        log.info("Bot client not configured, skipping alert for service %s", healthStatus["service_id"])
        return  // æœªé…ç½® bot å®¢æˆ·ç«¯
    }
    
    log.info("Processing alert for service %s", healthStatus["service_id"])

    serviceId = healthStatus["service_id"]
    currentTime = time.Now().Unix()

    // æ£€æŸ¥æ˜¯å¦åœ¨æŠ¥è­¦é—´éš”å†…
    alertedServicesMutex.Lock()
    shouldAlert = true
    lastAlertTime = 0
    if serviceId in alertedServices {
        lastAlertTime = alertedServices[serviceId]
        shouldAlert = (currentTime - lastAlertTime >= alertInterval)
    }
    alertedServicesMutex.Unlock()

    if !shouldAlert {
        timeSinceLastAlert = currentTime - lastAlertTime
        remainingTime = alertInterval - timeSinceLastAlert
        log.info("Alert cooldown for service %s: %d seconds remaining", serviceId, remainingTime)
        return
    }

    // è®°å½•æœ¬æ¬¡æŠ¥è­¦æ—¶é—´
    alertedServicesMutex.Lock()
    alertedServices[serviceId] = currentTime
    alertedServicesMutex.Unlock()

    // ç”ŸæˆæŠ¥è­¦æ¶ˆæ¯
    hostname, err = os.Hostname()
    if err != nil {
        hostname = "unknown"
    }

    alertTime = time.Now().Format("2006-01-02 15:04:05")

    markdown = sprintf(`ğŸš¨ æœåŠ¡å¥åº·æ£€æŸ¥æŠ¥è­¦

## âš ï¸ æœåŠ¡å¼‚å¸¸
- **æœåŠ¡åç§°**: %s
- **æœåŠ¡ID**: %s
- **æ£€æŸ¥URL**: %s
- **ä¸»æœº**: %s
- **æ—¶é—´**: %s

## ğŸ“Š æ£€æŸ¥ç»“æœ
- **çŠ¶æ€ç **: %d
- **å¥åº·çŠ¶æ€**: âŒ ä¸å¥åº·
- **æ£€æŸ¥è¯¦æƒ…**: %s

## ğŸ” å“åº”å†…å®¹
%s

---
*è¯·åŠæ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€*
`, healthStatus["service_name"], healthStatus["service_id"], healthStatus["service_name_en"],
   hostname, alertTime, healthStatus["status_code"], healthStatus["check_detail"], healthStatus["response"])

    // å‘é€æŠ¥è­¦
    try {
        botClient.SendMarkdown(markdown)
        log.info("Health alert sent for service: %s", serviceId)
    } catch err {
        log.error("Failed to send health alert for service %s: %v", serviceId, err)
    }

    // å‘é€ç®€å•æ–‡æœ¬æŠ¥è­¦ï¼ˆå¤‡ç”¨ï¼‰
    simpleMessage = sprintf("ğŸš¨ æŠ¥è­¦: %s (%s) æœåŠ¡å¼‚å¸¸ - çŠ¶æ€ç :%d - %s",
        healthStatus["service_name"], healthStatus["service_id"],
        healthStatus["status_code"], alertTime)

    try {
        botClient.SendText(simpleMessage)
    } catch err {
        log.error("Failed to send simple alert text for service %s: %v", serviceId, err)
    }
}

// å‘é€æœåŠ¡æ¢å¤é€šçŸ¥
sendRecoveryNotification = func(healthStatus) {
    if botClient == nil {
        return
    }
    
    log.info("Sending recovery notification for service: %s", healthStatus["service_id"])
    
    // ç”Ÿæˆæ¢å¤é€šçŸ¥æ¶ˆæ¯
    hostname, err = os.Hostname()
    if err != nil {
        hostname = "unknown"
    }
    
    recoveryTime = time.Now().Format("2006-01-02 15:04:05")
    
    markdown = sprintf(`âœ… æœåŠ¡æ¢å¤é€šçŸ¥

## ğŸ‰ æœåŠ¡å·²æ¢å¤æ­£å¸¸
- **æœåŠ¡åç§°**: %s
- **æœåŠ¡ID**: %s
- **æ£€æŸ¥URL**: %s
- **ä¸»æœº**: %s
- **æ¢å¤æ—¶é—´**: %s

## ğŸ“Š å½“å‰çŠ¶æ€
- **çŠ¶æ€ç **: %d
- **å¥åº·çŠ¶æ€**: âœ… æ­£å¸¸
- **æ£€æŸ¥è¯¦æƒ…**: %s

---
*æœåŠ¡å·²æ¢å¤æ­£å¸¸è¿è¡Œ*
`, healthStatus["service_name"], healthStatus["service_id"], healthStatus["service_name_en"],
   hostname, recoveryTime, healthStatus["status_code"], healthStatus["check_detail"])

    // å‘é€æ¢å¤é€šçŸ¥
    try {
        botClient.SendMarkdown(markdown)
        log.info("Recovery notification sent for service: %s", healthStatus["service_id"])
    } catch err {
        log.error("Failed to send recovery notification for service %s: %v", healthStatus["service_id"], err)
    }

    // å‘é€ç®€å•æ–‡æœ¬é€šçŸ¥ï¼ˆå¤‡ç”¨ï¼‰
    simpleMessage = sprintf("âœ… æ¢å¤: %s (%s) æœåŠ¡å·²æ¢å¤æ­£å¸¸ - çŠ¶æ€ç :%d - %s",
        healthStatus["service_name"], healthStatus["service_id"],
        healthStatus["status_code"], recoveryTime)

    try {
        botClient.SendText(simpleMessage)
    } catch err {
        log.error("Failed to send simple recovery text for service %s: %v", healthStatus["service_id"], err)
    }
}

// æ¸…é™¤æŠ¥è­¦çŠ¶æ€ï¼ˆæœåŠ¡æ¢å¤æ—¶è°ƒç”¨ï¼‰
clearAlertStatus = func(serviceId, healthStatus) {
    alertedServicesMutex.Lock()
    wasAlerted = serviceId in alertedServices
    if wasAlerted {
        delete(alertedServices, serviceId)
        log.info("Cleared alert status for service: %s", serviceId)
    }
    alertedServicesMutex.Unlock()
    
    // å¦‚æœä¹‹å‰æœ‰æŠ¥è­¦ï¼Œç°åœ¨æ¢å¤äº†ï¼Œå‘é€æ¢å¤é€šçŸ¥
    if wasAlerted && botClient != nil {
        sendRecoveryNotification(healthStatus)
    }
}

// =============================================================================
// æ‰¹é‡å¥åº·æ£€æŸ¥æ¨¡å— - æ£€æŸ¥æ‰€æœ‰é…ç½®çš„æœåŠ¡
// åŠŸèƒ½: éå†æ‰€æœ‰æœåŠ¡é…ç½®ï¼Œæ‰§è¡Œå¥åº·æ£€æŸ¥å¹¶æ›´æ–°çŠ¶æ€
// æŠ€æœ¯: å¹¶å‘æ‰§è¡Œæ£€æŸ¥ï¼Œä½¿ç”¨äº’æ–¥é”æ›´æ–°å…±äº«æ•°æ®
// =============================================================================

performHealthChecks = func() {
    log.info("Starting batch health check for %d services", len(serviceConfigs))
    currentTime = time.Now().Format("2006-01-02 15:04:05")
    println(f"\n[${currentTime}] å¼€å§‹å¥åº·æ£€æŸ¥...")
    
    newHealthData = []
    
    // éå†æ‰€æœ‰æœåŠ¡é…ç½®
    for config in serviceConfigs {
        healthStatus = checkServiceHealth(config)
        newHealthData = append(newHealthData, healthStatus)

        // è¾“å‡ºæ£€æŸ¥ç»“æœ
        statusIcon = "âœ“"
        if !healthStatus["is_healthy"] {
            statusIcon = "âœ—"
        }
        println(f"  ${statusIcon} ${healthStatus['service_name']} (${healthStatus['service_id']}): ${healthStatus['check_detail']}")

        // æŠ¥è­¦é€»è¾‘
        if !healthStatus["is_healthy"] {
            log.info("Service %s is unhealthy, attempting to send alert", healthStatus["service_id"])
            sendHealthAlert(healthStatus)
        } else {
            // æœåŠ¡æ¢å¤å¥åº·æ—¶ï¼Œæ¸…é™¤æŠ¥è­¦çŠ¶æ€
            clearAlertStatus(healthStatus["service_id"], healthStatus)
        }
    }
    
    // ä½¿ç”¨äº’æ–¥é”æ›´æ–°å¥åº·æ•°æ®
    healthDataMutex.Lock()
    healthData = newHealthData
    healthDataMutex.Unlock()
    
    log.info("Batch health check completed")
    println("å¥åº·æ£€æŸ¥å®Œæˆ\n")
}

// =============================================================================
// å®šæ—¶å¥åº·æ£€æŸ¥æ¨¡å— - åå°å®šæ—¶æ‰§è¡Œå¥åº·æ£€æŸ¥
// åŠŸèƒ½: åœ¨åå°å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
// æŠ€æœ¯: go fn{} å¯åŠ¨åç¨‹ï¼Œsleep æ§åˆ¶é—´éš”
// =============================================================================

startHealthCheckScheduler = func() {
    log.info("Starting health check scheduler (interval: %d seconds)", interval)
    
    // ç­‰å¾… botClient åˆå§‹åŒ–å®Œæˆ
    sleep(1)
    
    // å¯åŠ¨æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    performHealthChecks()
    
    // åå°å®šæ—¶æ‰§è¡Œ
    go fn {
        for {
            sleep(interval)
            performHealthChecks()
        }
    }
    
    log.info("Health check scheduler started")
}

// =============================================================================
// HTTP æœåŠ¡å™¨æ¨¡å— - å¯åŠ¨ Web æœåŠ¡æä¾›å¥åº·çŠ¶æ€å±•ç¤º
// åŠŸèƒ½: å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼Œæä¾› HTML ç•Œé¢å’Œ JSON API
// æŠ€æœ¯: httpserver.Serve å¯åŠ¨æœåŠ¡ï¼Œhttpserver.handler è®¾ç½®å¤„ç†å‡½æ•°
//
// API ç«¯ç‚¹:
// - GET / - è¿”å› HTML å¥åº·çŠ¶æ€å±•ç¤ºé¡µé¢
// - GET /health.json - è¿”å› JSON æ ¼å¼çš„å¥åº·çŠ¶æ€æ•°æ®
//
// å“åº”æ ¼å¼:
// [
//   {
//     "service_id": "aibalance",
//     "service_name": "AIå‡è¡¡å™¨",
//     "service_name_en": "AI Balance",
//     "status_code": 200,
//     "response": "...",
//     "updated_at": "2024-01-01T12:00:00Z"
//   }
// ]
// =============================================================================

startHTTPServer = func() {
    log.info("Starting HTTP server on 0.0.0.0:%d", port)
    
    pwd, err = os.Getwd()
    if err != nil {
        log.warn("Failed to get current working directory: %v", err)
        pwd = "."
    }

    // è¯»å– HTML æ–‡ä»¶ï¼ˆå°è¯•å¤šä¸ªå¯èƒ½çš„è·¯å¾„ï¼‰
    possiblePaths = [
        "apps/health-checking/index.html",
        "index.html",
        "./index.html",
        file.Join(pwd, "root", "yak-services-health-checking", `index.html`),
        file.Join(htmlDir, `index.html`),
    ]
    
    htmlContent = []
    htmlLoaded = false
    
    for htmlPath in possiblePaths {
        content, readErr = file.ReadFile(htmlPath)
        if readErr == nil {
            htmlContent = content
            htmlLoaded = true
            log.info("HTML file loaded from: %s", htmlPath)
            break
        }
    }
    
    if !htmlLoaded {
        log.error("Failed to load HTML file from any path")
        die("Failed to load HTML file")
    }
    
    // å¯åŠ¨ HTTP æœåŠ¡å™¨
    go fn {
        err = httpserver.Serve("0.0.0.0", port, httpserver.handler((rsp, req) => {
            log.info("Received request: %s %s from %s", req.Method, req.URL.Path, req.RemoteAddr)
            
            // å¤„ç†ä¸åŒçš„è·¯å¾„
            if req.URL.Path == "/" || req.URL.Path == "/index.html" {
                // è¿”å› HTML é¡µé¢
                log.info("Serving HTML page to %s", req.RemoteAddr)
                rsp.Header().Set("Content-Type", "text/html; charset=utf-8")
                rsp.WriteHeader(200)
                rsp.Write(htmlContent)
                
            } else if req.URL.Path == "/health.json" {
                // è¿”å› JSON æ•°æ®
                log.info("Serving health JSON to %s", req.RemoteAddr)
                
                // ä½¿ç”¨äº’æ–¥é”è¯»å–å¥åº·æ•°æ®
                healthDataMutex.Lock()
                currentData = healthData
                healthDataMutex.Unlock()
                
                // åºåˆ—åŒ–ä¸º JSON
                jsonData = json.dumps(currentData)
                
                rsp.Header().Set("Content-Type", "application/json; charset=utf-8")
                rsp.Header().Set("Access-Control-Allow-Origin", "*")
                rsp.WriteHeader(200)
                rsp.Write(jsonData)
                
            } else {
                // 404 Not Found
                log.warn("Path not found: %s", req.URL.Path)
                rsp.WriteHeader(404)
                rsp.Write(b`{"error": "Not Found"}`)
            }
        }))
        
        if err != nil {
            log.error("Failed to start HTTP server: %v", err)
            die(f"Failed to start HTTP server: ${err}")
        }
    }
    
    // ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
    sleep(1)
    
    log.info("HTTP server started successfully")
}

// =============================================================================
// ä¸»ç¨‹åºå…¥å£
// =============================================================================

println("\n" + "=" * 60)
println("YAK Services Health Checking System")
println("=" * 60)

// å¯åŠ¨å®šæ—¶å¥åº·æ£€æŸ¥
startHealthCheckScheduler()

// å¯åŠ¨ HTTP æœåŠ¡å™¨
startHTTPServer()

println(f"\nâœ“ å¥åº·æ£€æŸ¥æœåŠ¡å·²å¯åŠ¨")
println(f"âœ“ ç›‘æ§æœåŠ¡æ•°é‡: ${len(serviceConfigs)}")
println(f"âœ“ æ£€æŸ¥é—´éš”: ${interval} ç§’")
println(f"âœ“ Web ç•Œé¢: http://0.0.0.0:${port}")
println(f"âœ“ JSON API: http://0.0.0.0:${port}/health.json")
println("\næœåŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼ŒæŒ‰ Ctrl+C åœæ­¢")
println("=" * 60 + "\n")

// ä¿æŒè„šæœ¬è¿è¡Œ
for {
    sleep(1)
}

