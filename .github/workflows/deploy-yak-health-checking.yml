name: Deploy YAK Health Checking Service

on:
  # ÂΩìÊåáÂÆöÊñá‰ª∂ÊúâÊîπÂä®Êó∂Ëß¶Âèë
  push:
    branches:
      - main
    paths:
      - 'health-checking.yak'
      - 'index.html'
      - '.github/workflows/deploy-yak-health-checking.yml'
      - 'deploy.sh'
      - 'scripts/install-certs.sh'
  
  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:

# Á°Æ‰øùÂêå‰∏ÄÊó∂Èó¥Âè™ËøêË°å‰∏Ä‰∏™ÈÉ®ÁΩ≤‰ªªÂä°
concurrency:
  group: deploy-health-checking
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "============================================"
      
      - name: Download Yaklang Engine (v1.4.4-alpha1027)
        run: |
          echo "=== Downloading Yaklang Engine v1.4.4-alpha1027 ==="
          YAK_VERSION="1.4.4-alpha1027"
          YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
          
          echo "Downloading from: $YAK_URL"
          # Download with reduced progress output (every 3 seconds approximately)
          wget --progress=dot:binary -O ./yak "$YAK_URL" 2>&1 | \
            awk '/[0-9]+%/{i++; if(i%3==0) print; next} {print}' || true
          
          if [ ! -f ./yak ]; then
            echo "ERROR: Failed to download yak engine"
            echo "Trying alternative URL..."
            YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
            wget --progress=dot:binary -O ./yak "$YAK_URL" 2>&1 | \
              awk '/[0-9]+%/{i++; if(i%3==0) print; next} {print}' || exit 1
          fi
          
          chmod +x ./yak
          
          # È™åËØÅ‰∏ãËΩΩÁöÑÊñá‰ª∂
          echo ""
          echo "=== Downloaded file info ==="
          ls -lh ./yak
          file ./yak
          
          # ÊµãËØïÊâßË°å
          echo ""
          echo "=== Testing yak engine ==="
          ./yak version || echo "Note: yak version command may not be available in this version"
          
          echo ""
          echo "‚úì Yaklang engine downloaded and verified successfully"
      
      - name: Prepare SSH key
        env:
          HEALTH_CHECKING_HOST_PRI: ${{ secrets.HEALTH_CHECKING_HOST_PRI }}
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
        run: |
          echo "=== Preparing SSH deployment ==="
          
          if [ -z "$HEALTH_CHECKING_HOST_PRI" ] || [ -z "$HEALTH_CHECKING_HOST_ADDR" ]; then
            echo "ERROR: SSH credentials not found"
            echo "Please ensure HEALTH_CHECKING_HOST_PRI and HEALTH_CHECKING_HOST_ADDR secrets are set"
            exit 1
          fi
          
          # ÂàõÂª∫ÁßÅÈí•Êñá‰ª∂
          echo "$HEALTH_CHECKING_HOST_PRI" | tr -d '\r' > /tmp/pri
          chmod 600 /tmp/pri
          
          # È™åËØÅÁßÅÈí•Ê†ºÂºè
          if ! ssh-keygen -l -f /tmp/pri >/dev/null 2>&1; then
            echo "ERROR: Invalid SSH private key format"
            exit 1
          fi
          
          echo "‚úì SSH key prepared successfully"
      
      - name: Deploy to remote server
        env:
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
          LARK_BOT_NOTIFY_WEBHOOK: ${{ secrets.LARK_BOT_NOTIFY_WEBHOOK }}
        run: |
          echo "=== Deploying to remote server ==="
          echo "Target server: $HEALTH_CHECKING_HOST_ADDR"

          # Á°Æ‰øùÈÉ®ÁΩ≤ËÑöÊú¨ÊúâÊâßË°åÊùÉÈôê
          chmod +x ./deploy.sh

          # ÂáÜÂ§á webhook ÂèÇÊï∞ÔºàÁßªÈô§ÂâçÂêéÁ©∫Ê†ºÔºâ
          if [ -n "$LARK_BOT_NOTIFY_WEBHOOK" ]; then
            # ÁßªÈô§ÂâçÂêéÁ©∫Ê†º
            CLEANED_WEBHOOK=$(echo "$LARK_BOT_NOTIFY_WEBHOOK" | xargs)
            echo "Bot webhook configured for deployment"
            echo "Webhook length: ${#CLEANED_WEBHOOK}"
          else
            echo "No bot webhook configured"
            CLEANED_WEBHOOK=""
          fi

          # ÂáÜÂ§á webhook Êñá‰ª∂Âπ∂‰∏ä‰º†Âà∞ÊúçÂä°Âô®
          if [ -n "$CLEANED_WEBHOOK" ]; then
            echo "Preparing webhook file..."
            echo "$CLEANED_WEBHOOK" > /tmp/lark.txt
            echo "Webhook file created locally"
            
            # ‰∏ä‰º† webhook Êñá‰ª∂Âà∞ÊúçÂä°Âô®
            echo "Uploading webhook file to remote server..."
            ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --upload-file /tmp/lark.txt
            echo "‚úì Webhook file uploaded to /root/lark.txt"
            
            # È™åËØÅÊñá‰ª∂‰∏ä‰º†ÊàêÂäü
            echo "Verifying webhook file..."
            ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --command "ls -la /root/lark.txt && echo 'File size:' && wc -c < /root/lark.txt"
          else
            echo "No webhook configured, skipping webhook file creation"
          fi
          
          # ‰ΩøÁî® CI ‰∏≠ÁöÑÊúÄÊñ∞ deploy.sh ËÑöÊú¨ËøúÁ®ãÊâßË°å
          echo "Executing latest deploy.sh script on remote server..."
          ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --bash-script ./deploy.sh

          if [ $? -ne 0 ]; then
            echo "ERROR: Deployment failed"
            exit 1
          fi

          echo "‚úì Deployment completed successfully"
      
      - name: Verify deployment
        env:
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
        run: |
          echo "=== Verifying deployment ==="
          
          # Á≠âÂæÖÊúçÂä°ÂêØÂä®
          echo "Waiting for service to start..."
          sleep 10
          
          # ÈÄöËøá SSH È™åËØÅÊúçÂä°Áä∂ÊÄÅ
          ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --command "curl -f http://127.0.0.1:9901 >/dev/null 2>&1 && echo 'Service is running' || echo 'Service verification failed'"
          
          if [ $? -ne 0 ]; then
            echo "WARNING: Service verification failed, but deployment may still be successful"
            echo "Please check the service status manually"
          else
            echo "‚úì Service verification completed"
          fi
      
      - name: Install SSL Certificate (Optional)
        if: ${{ vars.ENABLE_SSL == 'true' }}
        env:
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
          SSL_DOMAIN: ${{ vars.SSL_DOMAIN }}
          SSL_EMAIL: ${{ vars.SSL_EMAIL }}
        run: |
          echo "=== Installing SSL Certificate ==="
          
          if [ -z "$SSL_DOMAIN" ] || [ -z "$SSL_EMAIL" ]; then
            echo "WARNING: SSL_DOMAIN or SSL_EMAIL not configured, skipping SSL installation"
            echo "To enable SSL, set the following repository variables:"
            echo "  - Variable: ENABLE_SSL=true"
            echo "  - Variable: SSL_DOMAIN=your-domain.com"
            echo "  - Variable: SSL_EMAIL=your-email@example.com"
            exit 0
          fi
          
          echo "Installing SSL certificate for domain: $SSL_DOMAIN"
          
          # ÈÄöËøá SSH ÊâßË°åËØÅ‰π¶ÂÆâË£ÖËÑöÊú¨
          ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --command "cd /root/yak-service-health-checking && ./scripts/install-certs.sh --domain '$SSL_DOMAIN' --port 9901 --email '$SSL_EMAIL' -y"
          
          if [ $? -eq 0 ]; then
            echo "‚úì SSL certificate installation completed"
          else
            echo "WARNING: SSL certificate installation failed, but deployment continues"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          rm -f /tmp/pri
          echo "‚úì Cleanup completed"
      
      - name: Summary
        if: success()
        run: |
          echo "## ‚úÖ Health Checking Service Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The YAK Health Checking service has been successfully deployed to the remote server." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- Service Name: \`yak-health-checking\`" >> $GITHUB_STEP_SUMMARY
          echo "- Port: \`9901\`" >> $GITHUB_STEP_SUMMARY
          echo "- Script: \`health-checking.yak\`" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Directory: \`/root/yak-service-health-checking\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Access Information" >> $GITHUB_STEP_SUMMARY
          echo "- HTTP: http://\${server-ip}:9901" >> $GITHUB_STEP_SUMMARY
          if [ "${{ vars.ENABLE_SSL }}" = "true" ] && [ -n "${{ vars.SSL_DOMAIN }}" ]; then
            echo "- HTTPS: https://${{ vars.SSL_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîí SSL Configuration" >> $GITHUB_STEP_SUMMARY
          if [ "${{ vars.ENABLE_SSL }}" = "true" ]; then
            echo "- SSL Enabled: ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "- Domain: ${{ vars.SSL_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- SSL Enabled: ‚ùå" >> $GITHUB_STEP_SUMMARY
            echo "- To enable SSL, configure ENABLE_SSL, SSL_DOMAIN, and SSL_EMAIL as repository variables" >> $GITHUB_STEP_SUMMARY
          fi
