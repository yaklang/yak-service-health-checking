name: Deploy YAK Health Checking Service

on:
  # å½“æŒ‡å®šæ–‡ä»¶æœ‰æ”¹åŠ¨æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'health-checking.yak'
      - 'index.html'
      - '.github/workflows/deploy-yak-health-checking.yml'
      - 'deploy.sh'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡
concurrency:
  group: deploy-health-checking
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Print trigger information
        run: |
          echo "============================================"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "============================================"
      
      - name: Download Yaklang Engine (v1.4.4-alpha1025)
        run: |
          echo "=== Downloading Yaklang Engine v1.4.4-alpha1025 ==="
          YAK_VERSION="1.4.4-alpha1025"
          YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
          
          echo "Downloading from: $YAK_URL"
          wget -q --show-progress -O ./yak "$YAK_URL"
          
          if [ ! -f ./yak ]; then
            echo "ERROR: Failed to download yak engine"
            echo "Trying alternative URL..."
            YAK_URL="https://yaklang.oss-accelerate.aliyuncs.com/yak/${YAK_VERSION}/yak_linux_amd64"
            wget -q --show-progress -O ./yak "$YAK_URL" || exit 1
          fi
          
          chmod +x ./yak
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
          echo ""
          echo "=== Downloaded file info ==="
          ls -lh ./yak
          file ./yak
          
          # æµ‹è¯•æ‰§è¡Œ
          echo ""
          echo "=== Testing yak engine ==="
          ./yak version || echo "Note: yak version command may not be available in this version"
          
          echo ""
          echo "âœ“ Yaklang engine downloaded and verified successfully"
      
      - name: Prepare SSH key
        env:
          HEALTH_CHECKING_HOST_PRI: ${{ secrets.HEALTH_CHECKING_HOST_PRI }}
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
        run: |
          echo "=== Preparing SSH deployment ==="
          
          if [ -z "$HEALTH_CHECKING_HOST_PRI" ] || [ -z "$HEALTH_CHECKING_HOST_ADDR" ]; then
            echo "ERROR: SSH credentials not found"
            echo "Please ensure HEALTH_CHECKING_HOST_PRI and HEALTH_CHECKING_HOST_ADDR secrets are set"
            exit 1
          fi
          
          # åˆ›å»ºç§é’¥æ–‡ä»¶
          echo "$HEALTH_CHECKING_HOST_PRI" | tr -d '\r' > /tmp/pri
          chmod 600 /tmp/pri
          
          # éªŒè¯ç§é’¥æ ¼å¼
          if ! ssh-keygen -l -f /tmp/pri >/dev/null 2>&1; then
            echo "ERROR: Invalid SSH private key format"
            exit 1
          fi
          
          echo "âœ“ SSH key prepared successfully"
      
      - name: Deploy to remote server
        env:
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
        run: |
          echo "=== Deploying to remote server ==="
          echo "Target server: $HEALTH_CHECKING_HOST_ADDR"
          
          # ç¡®ä¿éƒ¨ç½²è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x ./deploy.sh
          
          # é€šè¿‡ SSH æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --bash-script ./deploy.sh
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Deployment failed"
            exit 1
          fi
          
          echo "âœ“ Deployment completed successfully"
      
      - name: Verify deployment
        env:
          HEALTH_CHECKING_HOST_ADDR: ${{ secrets.HEALTH_CHECKING_HOST_ADDR }}
        run: |
          echo "=== Verifying deployment ==="
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "Waiting for service to start..."
          sleep 10
          
          # é€šè¿‡ SSH éªŒè¯æœåŠ¡çŠ¶æ€
          ./yak ssh -H "$HEALTH_CHECKING_HOST_ADDR" -i /tmp/pri --command "curl -f http://127.0.0.1:9901 >/dev/null 2>&1 && echo 'Service is running' || echo 'Service verification failed'"
          
          if [ $? -ne 0 ]; then
            echo "WARNING: Service verification failed, but deployment may still be successful"
            echo "Please check the service status manually"
          else
            echo "âœ“ Service verification completed"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          rm -f /tmp/pri
          echo "âœ“ Cleanup completed"
      
      - name: Summary
        if: success()
        run: |
          echo "## âœ… Health Checking Service Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The YAK Health Checking service has been successfully deployed to the remote server." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- Service Name: \`yak-health-checking\`" >> $GITHUB_STEP_SUMMARY
          echo "- Port: \`9901\`" >> $GITHUB_STEP_SUMMARY
          echo "- Script: \`health-checking.yak\`" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Directory: \`/root/yak-service-health-checking\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The service should now be accessible on port 9901 of the target server." >> $GITHUB_STEP_SUMMARY
